<!DOCTYPE html>
<html lang="en">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Marketing Blog</title>
<meta name="generator" content="Bootply" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/public/css/navbar.css">
<link rel="stylesheet" type="text/css" href="/public/css/shop.css">
<link rel="stylesheet" type="text/css" href="/public/css/main.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<!--script type="text/javascript" src='js/navbar.js'></script-->
<style type="text/css">
html,body {
    min-height: 100%;
}
#masthead {
    background-size: 115% auto;
}

#masthead.start {
    transition: all 5s ease-in-out;
    background-size: 100% auto;
    top: 0;
    left: 0;
    padding-top: 15%;
}

@media only screen and (max-width: 768px) {
    #masthead {
        background-size: auto 115%;
    }
    #masthead.start {
        transition: all 5s ease-in-out;
        background-size: auto 100%;
        top: 0;
        left: 0;
        padding-top: 15%;
        /*bottom: 0px;*/
    }
}

.controls {
    margin-top: 15px;
    /*vertical-align: middle;*/
}
/*.affix-bottom {
    position: relative
}*/
@media (min-width: 979px) {
    #sidebar.affix-bottom {
        position: relative
    }
    #sidebar.affix-top {
        position: static;
    }
    #sidebar.affix {
        position: fixed;
        top: 70px;
    }
}

#phasebeam {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
}

#phasebeam canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

.introduction .label {
    background-color: #5CB85C;
}

.animatedIcon {
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    -webkit-animation: iconAni 2s infinite;
    /* Safari 4+ */
    -moz-animation: iconAni 2s infinite;
    /* Fx 5+ */
    -o-animation: iconAni 2s infinite;
    /* Opera 12+ */
    animation: iconAni 2s infinite;
    /* IE 10+, Fx 29*/
}

@-webkit-keyframes iconAni {
    0% {
        background-color: #FFF;
        margin-top: 0px;
    }
    50% {
        background-color: #5CB85C;
        margin-top: 25px;
    }
    100% {
        background-color: #F0a;
        margin-top: 10px;
    }
}

@-moz-keyframes iconAni {
    0% {
        background-color: #FFF;
        margin-top: 0px;
    }
    50% {
        background-color: #5CB85C;
        margin-top: 25px;
    }
    100% {
        background-color: #F0a;
        margin-top: 10px;
    }
}

@-o-keyframes iconAni {
    0% {
        background-color: #FFF;
        margin-top: 0px;
    }
    50% {
        background-color: #5CB85C;
        margin-top: 25px;
    }
    100% {
        background-color: #F0a;
        margin-top: 10px;
    }
}

@keyframes iconAni {
    0% {
        background-color: #FFF;
        margin-top: 0px;
    }
    50% {
        background-color: #5CB85C;
        margin-top: 25px;
    }
    100% {
        background-color: #F0a;
        margin-top: 10px;
    }
}
</style>

<body style="background-color: rgb(0,0,0)">
    <!-- Dont touch this section -->
    <!-- masthead -->
    <div id="masthead">
        <!-- <div style="height:100%; width: 100%; background-color: rgba(0,0,0,.6)"></div> -->
        <div class="container-fluid">
            <div class="row cover">
                <div class="col-md-6 col-md-offset-1 ">
                    <h1><app-showname id="showName"></app-showname>
                        <!-- <hr style = "border-top: 1px solid rgba(255,255,255,.3)"> -->
                        <p class="lead"><app-slogan id = 'slogan' app-slogan = true>Shop chuyên hàng hiệu...!</app-slogan></p>
                    </h1>
                </div>
                <!-- <div class="col-md-5" style="padding-right:30px; bottom: 10px; right: 0px; position: absolute;"> -->
                <div class="col-md-5" style="padding:30px">
                    <!-- Primary Advertising Here -->
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <marketing-message>Tin tức khuyến mại</marketing-message>
                        </div>
                        <div class="panel-body">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis pharetra varius quam sit amet vulputate. Quisque mauris augue, molestie tincidunt condimentum vitae, gravida a libero. Aenean sit amet felis dolor, in sagittis nisi. Sed ac orci quis tortor imperdiet venenatis. Duis elementum auctor accumsan. Aliquam in felis sit amet augue.</div>
                    </div>
                    <!-- /Primary Advertising Here -->
                </div>
            </div>
        </div>
        <!-- /cont -->
    </div>
    <!-- /masthead -->
    <!-- NavBar -->
    <div id="nav-wrapper">
        <div id="nav" class="navbar navbar-inverse navbar-static-top navbar" role="navigation">
            <div class="container">
                <div class="row">
                    <a id = 'logoCover' app-backToHome=true>
                        <img id = "avatars" src="/public/img/CatLogo.png" class="logo">
                    </a>
                    <div id = 'companyName' class='site-name hidden-xs'>
                        <app-showName></app-showName>
                    </div>
                    <div class='navbar-left site-name phone'>
                        <i class="fa fa-phone "></i>
                        <!-- <i class="fa fa-facebook"></i> -->
                    </div>
                    <div class="navbar-header">
                        <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                    </div>
                    <nav class="collapse navbar-collapse " role="navigation">
                        <ul class="nav navbar-nav ">
                            <li class='navbar-right'>
                                <a id = "createNewShopMenu" class="createNewShop">Create a new Shop</a>
                            </li>
                            <li class='navbar-right'>
                                <a href="#sec">About</a>
                            </li>
                            <li class='navbar-right'>
                                <a href="#sec">Khuyến mãi</a>
                            </li>
                            <li class='navbar-right'>
                                <a href="#sec">Sản phẩm</a>
                            </li>
                            <li class='navbar-right '>
                                <a app-backToHome=true >Home</a>
                            </li>
                        </ul>
                        <ul class="nav navbar-nav navbar-right" id = "visitor">
                            <li class='navbar-right'>
                                <a><b id = 'quantityOfItems'></b><i class="fa fa-cart-plus" style="font-size: 18px;color: #fff"></i></a>
                            </li>
                            <li class='navbar-right' id='visitorHolder'>
                                <a href="#sec" id = "login"> <i class="fa fa-facebook fa-2x "></i><span> Login with Facebook</span></a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- /NavBar -->
    <!-- /Dont touch this section -->
    <!-- <div style="width:100%; height:20px; background-color: rgba(0,0,0,.5)"></div> -->
    <div class="container-fluid" id="start-offset" style="min-height: 100%;">
    <hr>

        <!--center-->
        <div class="col-sm-9 " style="min-height: 100%;">
            <ul class="nav nav-tabs">
              <li class="active"><a id = "cartReviewTab" data-toggle="tab" href="#cartReview">Duyệt đơn hàng</a></li>
              <li><a id = "orderReviewTab" data-toggle="tab" href="#orderReview">Hàng đã đặt</a></li>
            </ul>

            <div class="tab-content">
                <div id="cartReview" class="tab-pane fade in active">
                    <table class="table table-bordered" style="color:#fff;background-color: rgba(0,0,0,.6)">
                        <thead style="background-color:rgba(0,0,0,0.6)">
                            <tr>
                                <th class = "col-md-2">Product</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Order's Info</th>
                                <th>Remove</th>
                            </tr>
                        </thead>
                        <tbody id = "rootTable">
                        </tbody>
                        <tbody style="background-color: rgba(255,255,255,.2">
                            <tr>
                                <td>Tổng cộng : </td>
                                <td></td>
                                <td id = "summary"></td>
                                <td></td>
                                <td style="vertical-align: middle"><button app-role = "submit" type="button" class="btn btn-success center-block" id = "orderItems">Đặt hàng</button></td>
                            </tr>
                        </tbody>
                    </table> 
                </div>
                <div id="orderReview" class="tab-pane fade">
                    <table class="table table-bordered" style="color:#fff;background-color: rgba(0,0,0,.6)">
                        <thead style="background-color:rgba(0,0,0,0.6)">
                            <tr>
                                <th class = "col-md-2">Product</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Order's Info</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id = "orderTable">
                        </tbody>
                    </table> 
                </div>
            </div>
        </div>
        <!--/center-->
                <!-- Left Sidebar -->
        <div class="col-sm-3 hidden-xs">
            <!-- <div class="col-sm-3 col-md-pull-9"> -->
            <div id='sidebar' class='sidebar'>
                <!-- <h2>Side</h2> -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <marketing-message>Tin tức khuyến mại</marketing-message>
                    </div>
                    <div class="panel-body">Sed ac orci quis tortor imperdiet venenatis. Duis elementum auctor accumsan. Aliquam in felis sit amet augue.</div>
                </div>
                <hr>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <marketing-message>Tin tức khuyến mại</marketing-message>
                    </div>
                    <div class="panel-body">Content here..</div>
                </div>
                <hr>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <marketing-message>Tin tức khuyến mại</marketing-message>
                    </div>
                    <div class="panel-body">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis pharetra varius quam sit amet vulputate. Quisque mauris augue, molestie tincidunt condimentum vitae, gravida a libero. Aenean sit amet felis dolor, in sagittis nisi. Sed ac orci quis tortor imperdiet venenatis. Duis elementum auctor accumsan. Aliquam in felis sit amet augue.</div>
                </div>
                <hr>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <marketing-message>Tin tức khuyến mại</marketing-message>
                    </div>
                    <div class="panel-body">Content here..</div>
                </div>
                <hr>
            </div>
        </div>
        <!-- /Left Sidebar -->
    </div>
    <div id="end-offset">
        <footer>
            <div class="container-fluid" style="background-color:rgba(0,0,0,.65); ">
                <div class=" footer row cover " style="padding-top: 20px; padding-bottom: 40px;">
                    <div class="col-md-10 col-md-offset-1">
                        <div class="col-md-4" style='text-align: center; margin-top: 30px'>
                            <span style="font-size: 24px; color:white;  ">CON MÈO</span>
                            <p></p>
                            <a app-backToHome=true>
                                <img id = 'avatarFooter' style="width: 40%; margin-top: 30px">
                            </a>
                            <p></p>
                            <div app-slogan=true></div>
                        </div>
                        <div class="col-md-4" style="margin-top: 30px">
                            <span style="font-size: 24px; color:white; text-align: center "><i class="fa fa-arrows"></i>   THÔNG TIN...</span>
                            <p></p>
                            <li>Sản phẩm mới</li>
                            <li>Sản phẩm bán chạy nhất</li>
                            <li>Chúng tôi</li>
                            <li>Tin khuyến mại</li>
                            <li>Chính sách</li>
                        </div>
                        <div class="col-md-4" style="margin-top: 30px">
                            <span style="font-size: 24px; color:white; text-align: center "><i class="fa fa-user-plus"></i>  SẢN PHẨM...</span>
                            <P></P>
                            <li>keyword abc</li>
                            <li>keyword abc</li>
                            <li>keyword abc</li>
                            <li>keyword abc</li>
                            <li>keyword abc</li>
                        </div>
                    </div>
                </div>
                <!--/col-->
            </div>
            <div style=" width: 100%; background-color: rgba(0,0,0,.85); height: 90px;">
                @Copyright:abcd@abc.jsc
            </div>
        </footer>
    </div>
    <template id = 'singleItem'>
        <tr>
            <td>
            <img app-role = "icon" style="height:50px;width:auto">                        
                <label app-role= "product">Something</label>
            </td>
            <td app-role = "quantity"></td>
            <td app-role = "price"></td>
            <td app-role = "info"></td>
            <td style="vertical-align: middle"><button app-role = "removeBnt" type="button" class="btn btn-danger center-block" >Remove</button></td>
        </tr>
    </template>
    <template id = 'orderItem'>
        <tr>
            <td>
            <img app-role = "icon"  style="height:50px;width:auto">                        
                <label app-role= "product"></label><br>
                <label>Shop: </label>
                <div app-role= "shop"></div>
            </td>
            <td app-role = "quantity"></td>
            <td app-role = "price"></td>
            <td app-role = "info"></td>
            <td style="vertical-align: middle"><span app-role = "status" class="center-block" ></span></td>
        </tr>
    </template>

    <div id="phasebeam">
        <canvas width="700" height="650"></canvas>
        <canvas width="700" height="650"></canvas>
        <canvas width="700" height="650"></canvas>
    </div>
    <script type="text/javascript" src="/public/js/phasebeam.js"></script>
    <script type="text/javascript" src="/public/js/Crypto/cryptoUtils.js"></script>    
</body>
<script type="text/javascript">
$(function() {
    // $('#nav-wrapper').height($("#nav").height());
    // $('#nav-wrapper').height(200);
    $('#nav').affix({
        offset: {
            top: function() {
                // Do other stuff here-- chipl
                return $('#start-offset').offset().top / 2;
            }
        }
    });
    // Sidebar affix
    $('#sidebar').affix({
        offset: {
            top: $('#start-offset').offset().top + 0,
            bottom: $('#end-offset').outerHeight()+ 35
        }
    }).on('affix.bs.affix', function() { // before affix
        $(this).css({
            /*'top': headerHeight,*/ // for fixed height
            'width': $(this).outerWidth() // variable widths
        });
    }).on('affix-bottom.bs.affix', function() { // before affix-bottom
        // $(this).css('bottom', 'auto'); // THIS is what makes the jumping
    });;

});
var RSAPublicKey = <%-JSON.stringify(data)%>
var shop =  <%-JSON.stringify(shop)%>
var cartItemLists = JSON.parse(localStorage.getItem("cartItemLists"));
var orderId;

$(document).ready(function() {
    /** code inside **/

    // var masthead = $("#masthead");
    // masthead.addClass('start');
    if (localStorage.getItem("orderId") === null) {
        orderId =<%-JSON.stringify(orderId)%>
        localStorage.setItem("orderId", orderId);
    }else{
        orderId = localStorage.getItem("orderId");
    }
    var masthead = document.querySelector("#masthead");    
    masthead.style.backgroundImage  = "url('" + shop.walls.substring(1) +"')";
    masthead.classList.remove("hiddenElem");
    masthead.classList.add('start');
    document.getElementById('avatars').setAttribute('src',shop['avatars'].substring(1));  
    document.getElementById('avatarFooter').setAttribute('src',shop['avatars'].substring(1));
    document.getElementById('orderReviewTab').addEventListener('click',function(e){
        $.ajax({
        // url: './userToken',
        url: '/'+shop.pathName+'/order/'+orderId,
        method: 'get',
        complete: function(data, status, jqXHR) {
            var obj = JSON.parse(data.responseText);
            if (obj.err == 0) {
                updateOrderLists(obj.orderLists);
                console.log(obj.orderLists);
                }
            }
        });    
    },false);
    
    var showNames = document.querySelectorAll("app-showName");
    for(var i = 0 ; i< showNames.length; i++){
        showNames[i].innerHTML = shop.showName;
    }

    var backToHomes = document.querySelectorAll('[app-backToHome=true]');
        for(var i = 0; i< backToHomes.length;i++){
            // console.log(i, backToHomes(i));
            backToHomes[i].setAttribute("href", "/"+shop.pathName);
        }
    var slogans = document.querySelectorAll("[app-slogan=true]");
        for(var i = 0; i< slogans.length;i++){
            slogans[i].innerHTML = shop.slogan;
        }
    updateItemLists();
    startFacebook(document, 'script', 'facebook-jssdk');
});
function updateItemLists(){
    var rootTable = document.getElementById('rootTable');
    rootTable.innerHTML = null;
    var singleItem = document.getElementById('singleItem').content;
    var totalPaid = 0
    // console.log(cartItemLists);
    for(var i = 0; i<cartItemLists.length; i++){
        var icon = singleItem.querySelector('[app-role = "icon"]');
        icon.setAttribute('src','/public/products/'+cartItemLists[i].imgName[0]+ ".png")
        singleItem.querySelector('[app-role= "product"]').innerHTML = cartItemLists[i].productName;
        singleItem.querySelector('[app-role = "quantity"]').innerHTML = cartItemLists[i].qty;
        singleItem.querySelector('[app-role = "price"]').innerHTML= cartItemLists[i].newPrice + " VND/ " + cartItemLists[i].unit;
        var str  = '';
        str += "<label > " + "Người nhận: "+ "</label>" +cartItemLists[i].orderInfo.orderPerson +"<br>"
        str += "<label> " + "Phone: "+ "</label>" + cartItemLists[i].orderInfo.orderPhone +"<br>"
        str += "<label> " + "Địa chỉ: "+ "</label>" +cartItemLists[i].orderInfo.orderAddress
        singleItem.querySelector('[app-role = "info"]').innerHTML= str;
        singleItem.querySelector('[app-role = "removeBnt"]').setAttribute('id', cartItemLists[i]._id);
        rootTable.appendChild(document.importNode(singleItem,true));
        totalPaid += parseFloat(cartItemLists[i].newPrice)*cartItemLists[i].qty;
    }
    document.getElementById('summary').innerHTML = totalPaid + " VND " ;
    var removeBnts = document.querySelectorAll('[app-role = "removeBnt"]');
    for (var i= 0; i <removeBnts.length; i++){
        removeBnts[i].addEventListener('click',function(e){
            removeItem(this);
        },false)
    }
    document.getElementById('orderItems').addEventListener('click',function(e){
        orderItems_inCart()
    },false)
}
function removeItem(elem){
    var id = elem.id;
    for(var i = 0; i<cartItemLists.length; i++){
        if(cartItemLists[i]._id == id ){
            if( cartItemLists[i].qty > 1 ){
                cartItemLists[i].qty--;
                break;
            }else{
                cartItemLists.splice(i,1);                
                break;
            }
        }
    }
    localStorage.setItem("cartItemLists",JSON.stringify(cartItemLists));
    updateItemLists();
}
function orderItems_inCart(){
    if(!cartItemLists){
        return;
    }
    if (localStorage.getItem("app_token") === null) {
        getNewToken(uid, accessToken);
    }
    //2. get Token from localStorage
    token = localStorage.getItem("app_token");
    var _data = {
        userName: uid,
        password: token
    };
    aes_key = cryptoUtil.generateAESKey();
    var json_data = {
        data: cryptoUtil.EncryptJSON(_data, RSAPublicKey, aes_key)
    };
    json_data.orderId = orderId;    
    json_data.cartItems = JSON.stringify(cartItemLists);
    $.ajax({
        // url: './userToken',
        url: '/'+shop.pathName+'/order',
        method: 'POST',
        data: json_data,
        complete: function(data, status, jqXHR) {
            var obj = JSON.parse(data.responseText);
            if (obj.err == 0) {
                localStorage.setItem("cartItemLists", JSON.stringify([]));
                cartItemLists =[];
                rootTable.innerHTML = null;
            }
        }
    });
};
function updateOrderLists(orderLists){
    var orderTable = document.getElementById('orderTable');
    orderTable.innerHTML = null;    
    if(!orderLists){
        return;
    }
    
    var orderItem = document.getElementById('orderItem').content;
    
    for(var i = 0; i<orderLists.reverse().length; i++){
        var icon = orderItem.querySelector('[app-role = "icon"]');
        icon.setAttribute('src','/public/products/'+orderLists[i].imgName[0]+ ".png")
        orderItem.querySelector('[app-role= "product"]').innerHTML = orderLists[i].productName;
        orderItem.querySelector('[app-role = "quantity"]').innerHTML = orderLists[i].qty;
        orderItem.querySelector('[app-role = "price"]').innerHTML= orderLists[i].newPrice + " VND/ " + orderLists[i].unit;
        var str  = '';
        str += "<label > " + "Người nhận: "+ "</label>" +orderLists[i].orderInfo.orderPerson +"<br>"
        str += "<label> " + "Phone: "+ "</label>" + orderLists[i].orderInfo.orderPhone +"<br>"
        str += "<label> " + "Địa chỉ: "+ "</label>" +orderLists[i].orderInfo.orderAddress +"<br>"
        str += "<label> " + "Time: "+ "</label>" + orderLists[i].date;
        orderItem.querySelector('[app-role = "info"]').innerHTML= str;
        orderItem.querySelector('[app-role = "status"]').innerHTML = orderLists[i].status;
        orderItem.querySelector('[app-role = "shop"]').innerHTML = orderLists[i].shop;
        orderTable.appendChild(document.importNode(orderItem,true));
    }
}


function checkLoginStatus() {
    FB.getLoginStatus(function(response) {
        statusChangeCallback(response);
    });
}

window.fbAsyncInit = function() {
    FB.init({
        appId: '203172309854130',
        cookie: true, // enable cookies to allow the server to access 
        // the session
        xfbml: false, // parse social plugins on this page
        version: 'v2.4' // use version 2.2
    });

    FB.getLoginStatus(function(response) {
        statusChangeCallback(response);
    });

};

function startFacebook(d, s, id){
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s);
    js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
}


var aes_key;
var app_token;

function getNewToken(uid, token) {
    // console.log("uid: ", uid);
    //    console.log("accessToken: ", token);
    var _data = {
        userName: uid,
        password: token
    };
    aes_key = cryptoUtil.generateAESKey();
    var json_data = {
        data: cryptoUtil.EncryptJSON(_data, RSAPublicKey, aes_key)
    };
    
    $.ajax({
        // url: './userToken',
        url: '/api/gettoken',
        method: 'POST',
        data: json_data,
        // contentType:'application/json',
        complete: function(data, status, jqXHR) {
            var obj = JSON.parse(data.responseText);
            if (obj.err == 0) {
                var encrypted_app_token = obj.encrypted_app_token;
                // console.log('encrypted_app_token: ', encrypted_app_token);
                var _app_token = cryptoUtil.aesDecryptor(encrypted_app_token, aes_key);
                // console.log("typeof app_token: ", typeof(_app_token));
                // console.log('app_token: ', JSON.parse(_app_token).app_token);
                app_token = JSON.parse(_app_token).app_token;
                localStorage.setItem("app_token", app_token);
                addLinks();
            }else{
                    // for createNewShop id = "createNewShopMenu" class="createNewShop"
                var createNewLinks = document.querySelectorAll(".createNewShop");
                for (var i=0; i<createNewLinks.length; i++){            
                    createNewLinks[i].addEventListener('click', preventCreateNewShop ,false);
                };
            }

        }
    });
}

function checkToken(uid, accessToken) {
    //1. check wheather token is existed in localStorage
    if (localStorage.getItem("app_token") === null) {
        getNewToken(uid, accessToken);
        return;
    }
    //2. get Token from localStorage
    app_token = localStorage.getItem("app_token");
    // check Item validation
    var _data = {
        userName: uid,
        password: app_token
    };
    // _aes_key = cryptoUtil.generateAESKey();
    var json_data = {
        data: cryptoUtil.EncryptJSON(_data, RSAPublicKey)
    };
    $.ajax({
        // url: './userToken',
        url: '/api/checktoken',
        method: 'POST',
        data: json_data,
        complete: function(data, status, jqXHR) {
            var obj = JSON.parse(data.responseText);
            if (obj.err != 0) {
                getNewToken(uid, accessToken);
                return;
            }
            addLinks();
        }
    });
}

function addLinks(){
    isLoggedIn = true;
    var createNewLinks = document.querySelectorAll(".createNewShop");
    for (var i=0; i<createNewLinks.length; i++){            
        createNewLinks[i].removeEventListener('click', preventCreateNewShop , false)
        createNewLinks[i].setAttribute("href", "/createnewshop");
    }
}

function fetchingInfo(callback) {

    // console.log('Welcome!  Fetching your information.... ');
    FB.api('/me', 'GET', {
        "fields": "id,name,email"
    }, function(response) {        
        callback(response);
    });

}

function handleFBData(response) {
    // document.getElementById('status').innerHTML = 'Thanks for logging in, ' + response.name + '!';
    var visitorHolder = document.querySelector('#visitorHolder');        
    // console.log("visitorHolder", visitorHolder);
    var parent = visitorHolder.parentNode;
    parent.removeChild(visitorHolder);
    FB.api('/me/picture?type=small', function(response) {
        // document.getElementById("profileImage").setAttribute("src", response.data.url);
        console.log(response.data.url);
        var _img = document.querySelector("#avatar");        
        _img.setAttribute("src", response.data.url);
        _img.style.border = "0";
            
    });

    var _li = document.createElement('li');
    _li.classList.add ("navbar-right");    
    // _li.style.marginTop= "10px";
    var _a = document.createElement('a');
    var _span = document.createElement('span');
    var _div = document.createElement('div');
    var _img = document.createElement('img');

    _div.classList.add('navbar-right');
    _div.style.with = "25px";
    _div.style.height = "25px";
    _div.style.width = "204x";
    _div.style.overflow = "hidden";

    _img.style.width = "25px";
    _img.style.height = "auto";
    // _img.style.paddingLeft = "10px";
    _img.setAttribute("id", "avatar");    
    _div.appendChild(_img);
    _span.appendChild(_div);

    _a.appendChild(_span);
    _a.style.color = "#fff";
    var t = document.createTextNode( String.fromCharCode(160)+ response.name +  String.fromCharCode(160));
    _a.appendChild(t);
    _li.appendChild(_a)
    parent.appendChild(_li);
    // console.log("parent", parent);

}

var isLoggedIn = false;
// This is called with the results from from FB.getLoginStatus().
var uid
function statusChangeCallback(response) {

    // The response object is returned with a status field that lets the
    // app know the current login status of the person.
    // Full docs on the response object can be found in the documentation
    // for FB.getLoginStatus().
    if (response.status === 'connected') {
        fetchingInfo(handleFBData);
        uid = response.authResponse.userID;
        var accessToken = response.authResponse.accessToken;        
        checkToken(uid, accessToken);

    } else if (response.status === 'not_authorized') {
        // The person is logged into Facebook, but not your app.
        // document.getElementById('status').innerHTML += 'Please log ' +
        // 'into this app.';
        addLoginListener();
    } else {
        // The person is not logged into Facebook, so we're not sure if
        // they are logged into this app or not.
        // document.getElementById('status').innerHTML += 'Please log ' +
        // 'into Facebook.';
        addLoginListener();
    }
    function addLoginListener(){
        var login = document.querySelector('#visitor');
        login.addEventListener('click',fb_enter,false);  
    }    
}


function fb_enter() {
    // console.log("okie here");
    FB.login(function(response) {
        console.log(response);
        if (response.status === 'connected') {
            statusChangeCallback(response);
        }
    }, {})

}
function preventCreateNewShop(){}


</script>

</html>
